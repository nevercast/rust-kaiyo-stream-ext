<html>
  <head>

  </head>
  <body>
    <!-- display the current selected_model_name -->
    <h1 id="selected_model_name"></h1>
    <!-- display the 3 previous selected_model_name in a rolling list -->
    <ul>
      <li id="history_1"></li>
      <li id="history_2"></li>
      <li id="history_3"></li>
    </ul>
    <script>
      // Add a timer to show how long the current model has been selected
      let model_changed_at = new Date();

      previous_selected_model_name = '';
      selected_model_history = ['', '', ''];

      function connect(message_handler) {
        debugger;
        var ws = new WebSocket('ws://' + window.location.host + '/ws');
        ws.onopen = function() {
          console.log('Connected to server');
        };

        ws.onclose = function(e) {
          console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
          setTimeout(function() {
            connect(message_handler);
          }, 1000);
        };

        ws.onerror = function(err) {
          console.error('Socket encountered error: ', err.message, 'Closing socket');
          ws.close();
        };

        ws.onmessage = function(e) {
          debugger;
          let data;
          try {
            data = JSON.parse(e.data);
          } catch (err) {
            console.error('Error parsing JSON', err);
          }
          try {
            message_handler(data);
          } catch (err) {
            console.error('Error handling message', err);
          }
        };
      }

      // listen for the 'evtsel' event from the Flask server
      connect((data) => {
        let selected_model_name = data.model;
        // if the selected_model_name has changed, update the display
        if (selected_model_name != previous_selected_model_name) {
          // update the display
          document.getElementById('selected_model_name').innerHTML = selected_model_name;
          // update the history
          if (previous_selected_model_name != '') {
            selected_model_history.unshift(previous_selected_model_name + ' (' + (new Date() - model_changed_at) / 1000 + 's)');
          }
          model_changed_at = new Date();
          if (selected_model_history.length > 3) {
            selected_model_history.pop();
          }
          document.getElementById('history_1').innerHTML = selected_model_history[0];
          document.getElementById('history_2').innerHTML = selected_model_history[1];
          document.getElementById('history_3').innerHTML = selected_model_history[2];
          // update the previous_selected_model_name
          previous_selected_model_name = selected_model_name;
        }
      });

      setInterval(() => {
        if (previous_selected_model_name == '') {
          return;
        }
        // update the display
        let now = new Date();
        let elapsed = (now - model_changed_at) / 1000;
        document.getElementById('selected_model_name').innerHTML = previous_selected_model_name + ' (' + elapsed + 's)';
      }, 125);
    </script>
  </body>
</html>
